<!DOCTYPE html>
<html>
<head>
  <title>Driver Panel - Live Location Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; text-align: center; background: #f9f9f9; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; font-size: 16px; }
    #status { margin-top: 15px; font-weight: bold; }
    #logoutBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>üßë‚Äç‚úàÔ∏è Driver Panel - Live Location</h2>

  <!-- Login Form -->
  <div id="loginBox">
    <input type="text" id="driverId" placeholder="Driver ID" />
    <input type="password" id="driverPass" placeholder="Password" />
    <button onclick="loginDriver()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- Driver Panel -->
  <div id="driverPanel" style="display:none;">
    <p>Welcome, <span id="driverName"></span>!</p>
    <button onclick="startTracking()">Start Location Update</button>
    <button onclick="stopTracking()" disabled id="stopBtn">Stop Location</button>
    <button id="logoutBtn" onclick="logoutDriver()">Logout</button>
    <p id="status"></p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyA01RW_-AK7DzZp9sd92GDZpExIVvMVbBY",
      authDomain: "ringasbustracker.firebaseapp.com",
      databaseURL: "https://ringasbustracker-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ringasbustracker",
      storageBucket: "ringasbustracker.firebasestorage.app",
      messagingSenderId: "894338476193",
      appId: "1:894338476193:web:125d89e35d8ada1822a8e0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let watchId = null;
    let currentDriverId = null;
    let driverRoute = null;
    let lastUpdateTime = 0;

    // Login Driver
    function loginDriver() {
      const id = document.getElementById("driverId").value.trim();
      const pass = document.getElementById("driverPass").value.trim();
      const email = id + "@busapp.com";
      const errorP = document.getElementById("loginError");

      if (!id || !pass) {
        errorP.innerText = "Please enter Driver ID and Password.";
        return;
      }

      auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
          errorP.innerText = "";
          currentDriverId = id;
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("driverPanel").style.display = "block";
          document.getElementById("driverName").innerText = currentDriverId;

          // Fetch driver's route
          db.ref("drivers/" + currentDriverId + "/route").once("value").then(snapshot => {
            driverRoute = snapshot.val();
            if (!driverRoute) {
              alert("Route not found. Please contact admin.");
            }
          });
        })
        .catch(error => {
          errorP.innerText = error.message;
        });
    }

    // Start Location Tracking
    function startTracking() {
      if (!navigator.geolocation) {
        alert("Your browser does not support geolocation.");
        return;
      }
      if (!driverRoute) {
        alert("Route not set.");
        return;
      }

      document.getElementById("status").innerText = "Location tracking started...";
      document.getElementById("stopBtn").disabled = false;

      watchId = navigator.geolocation.watchPosition(position => {
        const now = Date.now();
        if (now - lastUpdateTime >= 2000) {
          lastUpdateTime = now;

          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          const locationData = {
            lat: lat,
            lng: lng,
            updatedAt: new Date().toISOString()
          };

          db.ref(driverRoute + "/current").set(locationData);
          db.ref(driverRoute + "/history/" + now).set(locationData);

          document.getElementById("status").innerText = `Updated: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }
      }, error => {
        document.getElementById("status").innerText = "Location error: " + error.message;
      }, {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      });
    }

    // Stop Location Tracking
    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        document.getElementById("status").innerText = "Location tracking stopped.";
        document.getElementById("stopBtn").disabled = true;
      }
    }

    // Logout
    function logoutDriver() {
      stopTracking();
      auth.signOut().then(() => {
        currentDriverId = null;
        driverRoute = null;
        document.getElementById("driverPanel").style.display = "none";
        document.getElementById("loginBox").style.display = "block";
        document.getElementById("driverId").value = "";
        document.getElementById("driverPass").value = "";
        document.getElementById("loginError").innerText = "";
        document.getElementById("status").innerText = "";
      });
    }
  </script>
</body>
</html>
