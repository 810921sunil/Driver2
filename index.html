<!DOCTYPE html>
<html>
<head>
  <title>Driver Panel - рд▓рд╛рдЗрд╡ рд▓реЛрдХреЗрд╢рди рдЕрдкрдбреЗрдЯ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; text-align: center; background: #f9f9f9; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; font-size: 16px; }
    #status { margin-top: 15px; font-weight: bold; }
    #logoutBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>ЁЯЪН Driver Panel - рд▓реЛрдХреЗрд╢рди рдЕрдкрдбреЗрдЯ</h2>

  <!-- ЁЯФР рд▓реЙрдЧрд┐рди рдлреЙрд░реНрдо -->
  <div id="loginBox">
    <input type="text" id="driverId" placeholder="Driver ID" />
    <input type="password" id="driverPass" placeholder="Password" />
    <button onclick="loginDriver()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- тЬЕ рд▓реЙрдЧрд┐рди рдХреЗ рдмрд╛рдж рдкреИрдирд▓ -->
  <div id="driverPanel" style="display:none;">
    <p>Welcome, <span id="driverName"></span>!</p>
    <button onclick="startTracking()">ЁЯЪА рд▓реЛрдХреЗрд╢рди рдЕрдкрдбреЗрдЯ рд╢реБрд░реВ рдХрд░реЗрдВ</button>
    <button onclick="stopTracking()" disabled id="stopBtn">ЁЯЫС рд▓реЛрдХреЗрд╢рди рдмрдВрдж рдХрд░реЗрдВ</button>
    <button id="logoutBtn" onclick="logoutDriver()">ЁЯЪк Logout</button>
    <p id="status"></p>
  </div>

  <!-- ЁЯФе Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    // ЁЯФз Firebase Config (рдЕрдкрдирд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧ рд░рдЦреЗрдВ)
    const firebaseConfig = {
      apiKey: "AIzaSyA01RW_-AK7DzZp9sd92GDZpExIVvMVbBY",
      authDomain: "ringasbustracker.firebaseapp.com",
      databaseURL: "https://ringasbustracker-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ringasbustracker",
      storageBucket: "ringasbustracker.firebasestorage.app",
      messagingSenderId: "894338476193",
      appId: "1:894338476193:web:125d89e35d8ada1822a8e0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let watchId = null;
    let currentDriverId = null;
    let driverRoute = null;
    let lastUpdateTime = 0;

    // ЁЯФР рдбреНрд░рд╛рдЗрд╡рд░ рд▓реЙрдЧрд┐рди рдлрдВрдХреНрд╢рди
    function loginDriver() {
      const id = document.getElementById("driverId").value.trim();
      const pass = document.getElementById("driverPass").value.trim();
      const email = id + "@busapp.com";
      const errorP = document.getElementById("loginError");

      if (!id || !pass) {
        errorP.innerText = "рдХреГрдкрдпрд╛ Driver ID рдФрд░ Password рднрд░реЗрдВред";
        return;
      }

      auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
          errorP.innerText = "";
          currentDriverId = id;
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("driverPanel").style.display = "block";
          document.getElementById("driverName").innerText = currentDriverId;

          db.ref("drivers/" + currentDriverId + "/route").once("value").then(snapshot => {
            driverRoute = snapshot.val();
            if (!driverRoute) {
              alert("рдЖрдкрдХрд╛ рдмрд╕ рд░реВрдЯ рд╕реЗрдЯ рдирд╣реАрдВ рд╣реИ, рдХреГрдкрдпрд╛ рдПрдбрдорд┐рди рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВред");
            }
          });
        })
        .catch(error => {
          errorP.innerText = error.message;
        });
    }

    // ЁЯЪА рд▓реЛрдХреЗрд╢рди рдЯреНрд░реИрдХрд┐рдВрдЧ рд╢реБрд░реВ рдХрд░реЗрдВ
    function startTracking() {
      if (!navigator.geolocation) {
        alert("рдЖрдкрдХрд╛ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд▓реЛрдХреЗрд╢рди рд╕рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдХрд░рддрд╛ред");
        return;
      }
      if (!driverRoute) {
        alert("рд░реВрдЯ рд╕реЗрдЯ рдирд╣реАрдВ рд╣реИред");
        return;
      }

      document.getElementById("status").innerText = "ЁЯФД рд▓реЛрдХреЗрд╢рди рдЯреНрд░реИрдХрд┐рдВрдЧ рд╢реБрд░реВ...";
      document.getElementById("stopBtn").disabled = false;

      // ЁЯУН рд▓реЛрдХреЗрд╢рди рд▓рдЧрд╛рддрд╛рд░ рднреЗрдЬреЗрдВ рд╣рд░ 2 рд╕реЗрдХрдВрдб рдореЗрдВ
      watchId = navigator.geolocation.watchPosition(position => {
        const now = Date.now();
        if (now - lastUpdateTime >= 2000) {
          lastUpdateTime = now;

          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          const locationData = {
            lat: lat,
            lng: lng,
            updatedAt: new Date().toLocaleString()
          };

          // тЬЕ рд╡рд░реНрддрдорд╛рди рд▓реЛрдХреЗрд╢рди рд╕реЗрд╡ рдХрд░реЗрдВ
          db.ref(driverRoute + "/current").set(locationData);

          // ЁЯХТ рдЗрддрд┐рд╣рд╛рд╕ (history) рдореЗрдВ рд╕реЗрд╡ рдХрд░реЗрдВ
          const timestamp = now;
          db.ref(driverRoute + "/history/" + timestamp).set(locationData);

          document.getElementById("status").innerText = `ЁЯУН рдЕрдкрдбреЗрдЯ: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }
      }, error => {
        document.getElementById("status").innerText = "тЭМ рд▓реЛрдХреЗрд╢рди рдореЗрдВ рд╕рдорд╕реНрдпрд╛: " + error.message;
      }, {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      });
    }

    // ЁЯЫС рд▓реЛрдХреЗрд╢рди рдЯреНрд░реИрдХрд┐рдВрдЧ рдмрдВрдж рдХрд░реЗрдВ
    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        document.getElementById("status").innerText = "ЁЯЫС рд▓реЛрдХреЗрд╢рди рдЯреНрд░реИрдХрд┐рдВрдЧ рдмрдВрдж рдХрд░ рджреА рдЧрдИред";
        document.getElementById("stopBtn").disabled = true;
      }
    }

    // ЁЯЪк рдбреНрд░рд╛рдЗрд╡рд░ рд▓реЙрдЧрдЖрдЙрдЯ
    function logoutDriver() {
      stopTracking();
      auth.signOut().then(() => {
        currentDriverId = null;
        driverRoute = null;
        document.getElementById("driverPanel").style.display = "none";
        document.getElementById("loginBox").style.display = "block";
        document.getElementById("driverId").value = "";
        document.getElementById("driverPass").value = "";
        document.getElementById("loginError").innerText = "";
        document.getElementById("status").innerText = "";
      });
    }
  </script>
</body>
</html>
